# Loading data

åœ¨æ¸²æŸ“ä¸€å€‹ `+page.svelte` çµ„ä»¶(åŠå…¶åŒ…å«çš„ `+layout.svelte` çµ„ä»¶)ä¹‹å‰ï¼Œæˆ‘å€‘é€šå¸¸éœ€è¦ç²å–ä¸€äº›æ•¸æ“šã€‚é€™æ˜¯é€šéå®šç¾© `load` å‡½æ•¸ä¾†å¯¦ç¾çš„ã€‚

## Page data
`src/routes/blog/[slug]/+page.svelte`
```svelte
<script>
	/** @type {{ data: import('./$types').PageData }} */
	let { data } = $props();

    // Svelte 4
    export let data
</script>

<h1>{data.title}</h1>
<div>{@html data.content}</div>
```
> åœ¨ Svelte 4 ä¸­ï¼Œéœ€è¦ä½¿ç”¨ `export let data` ä»£æ›¿

`src/routes/blog/[slug]/+page`
```js
import { error } from '@sveltejs/kit';

// import type { PageLoad } from './$types';
/** @type {import('./$types').PageLoad} */
export function load({ params }) {
	if (params.slug === 'hello-world') {
		return {
			title: 'Hello world!',
			content: 'Welcome to our blog. Lorem ipsum dolor sit amet...'
		};
	}

	error(404, 'Not found');
}
```

`+page.js` æ–‡ä»¶ä¸­çš„ `load` å‡½æ•¸åœ¨æœå‹™ç«¯å’Œç€è¦½å™¨ä¸Šéƒ½æœƒé‹è¡Œ(é™¤éèˆ‡ `export const ssr = false` çµåˆä½¿ç”¨ï¼Œåœ¨é€™ç¨®æƒ…æ³ä¸‹å®ƒå°‡åƒ…åœ¨ç€è¦½å™¨ä¸­é‹è¡Œ)ã€‚å¦‚æœæ‚¨çš„ `load` å‡½æ•¸æ‡‰è©²å§‹çµ‚åœ¨æœå‹™ç«¯ä¸Šé‹è¡Œ(ä¾‹å¦‚ï¼Œå› ç‚ºå®ƒä½¿ç”¨äº†ç§æœ‰ç’°å¢ƒè®Šé‡æˆ–è¨ªå•æ•¸æ“šåº«)ï¼Œé‚£éº¼å®ƒæ‡‰è©²æ”¾åœ¨ `+page.server.js` ä¸­ã€‚

ä¸€å€‹æ›´è²¼åˆå¯¦éš›çš„ blog æ–‡ç«  `load` å‡½æ•¸ç¤ºä¾‹ï¼Œå®ƒåªåœ¨æœå‹™ç«¯ä¸Šé‹è¡Œä¸¦å¾æ•¸æ“šåº«ä¸­ç²å–æ•¸æ“šã€‚å¯èƒ½å¦‚ä¸‹æ‰€ç¤º:

` src/routes/blog/[slug]/+page.server.js`
```js
// @filename: ambient.d.ts
declare module '$lib/server/database' {
	export function getPost(slug: string): Promise<{ title: string, content: string }>
}

// @filename: index.js
// ---cut---
import * as db from '$lib/server/database';

/** @type {import('./$types').PageServerLoad} */
export async function load({ params }) {
	return {
		post: await db.getPost(params.slug)
	};
}
```

æ³¨æ„é¡å‹å¾ `PageLoad` è®Šç‚º `PageServerLoad`ï¼Œå› ç‚ºæœå‹™ç«¯ `load` å‡½æ•¸å¯ä»¥è¨ªå•é¡å¤–çš„åƒæ•¸ã€‚

è¦äº†è§£ä½•æ™‚ä½¿ç”¨ `+page.js` å’Œä½•æ™‚ä½¿ç”¨ `+page.server.js` , æ–‡æª”ï¼š[é«˜ç´šè·¯ç”± - Universal èˆ‡ serverã€‚]()

## Layout data
`+layout.svelte` æ–‡ä»¶ä¹Ÿå¯ä»¥é€šé `+layout.js` æˆ– `+layout.server.js` åŠ è¼‰æ•¸æ“šã€‚

`src/routes/blog/[slug]/+layout.server.js`
```js
// @filename: ambient.d.ts
declare module '$lib/server/database' {
	export function getPostSummaries(): Promise<Array<{ title: string, slug: string }>>
}

// @filename: index.js
// ---cut---
import * as db from '$lib/server/database';

/** @type {import('./$types').LayoutServerLoad} */
export async function load() {
	return {
		posts: await db.getPostSummaries()
	};
}
```

`src/routes/blog/[slug]/+layout.svelte`
```svelte
<script>
	/** @type {{ data: import('./$types').LayoutData, children: Snippet }} */
	let { data, children } = $props();
</script>

<main>
	<!-- +page.svelte åœ¨æ­¤è™•è¢« `@render` -->
	{@render children()}
</main>

<aside>
	<h2>More posts</h2>
	<ul>
		{#each data.posts as post}
			<li>
				<a href="/blog/{post.slug}">
					{post.title}
				</a>
			</li>
		{/each}
	</ul>
</aside>
```

ä½ˆå±€ `load` å‡½æ•¸è¿”å›çš„è³‡æ–™å¯ä¾›å­ `+layout.svelte` çµ„ä»¶å’Œ `+page.svelte` çµ„ä»¶ä»¥åŠå®ƒ"æ‰€å±¬"çš„ä½ˆå±€éƒ½å¯ç”¨ã€‚

`src/routes/blog/[slug]/+page`
```svelte
<script>
	import { page } from '$app/state';

	/** @type {import('./$types').PageProps} */
	let { data } = $props();

	// æˆ‘å€‘å¯ä»¥è¨ªå• data.posts å› ç‚ºå®ƒæ˜¯å¾
	// çˆ¶ä½ˆå±€çš„ load å‡½æ•¸è¿”å›çš„
	let index = $derived(data.posts.findIndex(post => post.slug === page.params.slug));
	let next = $derived(data.posts[index + 1]);
</script>

<h1>{data.post.title}</h1>
<div>{@html data.post.content}</div>

{#if next}
	<p>Next post: <a href="/blog/{next.slug}">{next.title}</a></p>
{/if}
```

> â— å¦‚æœå¤šå€‹ load å‡½æ•¸è¿”å›å…·æœ‰ç›¸åŒéµçš„æ•¸æ“šï¼Œæœ€å¾Œä¸€å€‹æœƒ"å‹å‡º" â€”â€” ä½ˆå±€ load è¿”å› { a: 1, b: 2 } è€Œé é¢ load è¿”å› { b: 3, c: 4 } çš„çµæœå°‡æ˜¯ { a: 1, b: 3, c: 4 }ã€‚

## page.data
`+page.svelte` çµ„ä»¶åŠå…¶ä¸Šé¢çš„æ¯å€‹ `+layout.svelte` çµ„ä»¶éƒ½å¯ä»¥è¨ªå•è‡ªå·±çš„æ•¸æ“šä»¥åŠå…¶æ‰€æœ‰çˆ¶çµ„ä»¶çš„æ•¸æ“šã€‚
åœ¨æŸäº›æƒ…æ³ä¸‹ï¼Œæˆ‘å€‘å¯èƒ½éœ€è¦ç›¸åçš„æ•ˆæœ - çˆ¶ä½ˆå±€å¯èƒ½éœ€è¦è¨ªå•é é¢æ•¸æ“šæˆ–ä¾†è‡ªå­ä½ˆå±€çš„æ•¸æ“šã€‚ä¾‹å¦‚ï¼Œæ ¹ä½ˆå±€å¯èƒ½æƒ³è¦è¨ªå•å¾ `+page.js` æˆ– `+page.server.js` ä¸­çš„ `load` å‡½æ•¸è¿”å›çš„ `title` å±¬æ€§ã€‚é€™å¯ä»¥é€šé `page.data` å¯¦ç¾:

`src/routes/+layout.svelte`
```svelte
<script>
	import { page } from '$app/state';
</script>

<svelte:head>
	<title>{page.data.title}</title>
</svelte:head>
```

`page.data` çš„é¡å‹ä¿¡æ¯ç”± `App.PageData` æä¾›ã€‚

> âš ï¸ `$app/state` æ˜¯åœ¨ SvelteKit 2.12 ä¸­æ·»åŠ çš„ã€‚å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯æ—©æœŸç‰ˆæœ¬æˆ–ä½¿ç”¨ Svelte 4ï¼Œè«‹ä½¿ç”¨ `$app/stores` ä»£æ›¿ã€‚å®ƒæä¾›äº†ä¸€å€‹å…·æœ‰ç›¸åŒæ¥å£çš„ `page` storeï¼Œæ‚¨å¯ä»¥è¨‚é–²å®ƒï¼Œä¾‹å¦‚ `$page.data.title`ã€‚

## Universal vs server
ç›®å‰æœ‰å…©ç¨®é¡å‹çš„ load å‡½æ•¸:
- `+page.js` å’Œ `+layout.js` æ–‡ä»¶å°å‡ºçš„åœ¨æœå‹™ç«¯å’Œç€è¦½å™¨ä¸Šéƒ½é‹è¡Œçš„<b>Universal</b> `load` å‡½æ•¸
- `+page.server.js` å’Œ `+layout.server.js` æ–‡ä»¶å°å‡ºçš„åªåœ¨æœå‹™ç«¯é‹è¡Œçš„<b>server</b> `load` å‡½æ•¸

### When does which load function run?
server `load` å‡½æ•¸ç¸½æ˜¯åœ¨æœå‹™ç«¯ä¸Šé‹è¡Œã€‚

é è¨­æƒ…æ³ä¸‹ï¼ŒUniversal `load` å‡½æ•¸åœ¨ç”¨æˆ·é¦–æ¬¡è¨ªå•é é¢æ™‚åœ¨ SSR æœŸé–“åœ¨æœå‹™ç«¯ä¸Šé‹è¡Œã€‚ç„¶å¾Œå®ƒå€‘æœƒåœ¨hydration ä¸­å†æ¬¡é‹è¡Œï¼Œè¤‡ç”¨ä¾†è‡ª fetch è«‹æ±‚çš„ä»»ä½•éŸ¿æ‡‰ã€‚æ‰€æœ‰å¾ŒçºŒèª¿ç”¨ Universal `load` å‡½æ•¸éƒ½ç™¼ç”Ÿåœ¨ç€è¦½å™¨ä¸­ã€‚æ‚¨å¯ä»¥é€šéé é¢é¸é …è‡ªå®šç¾©è©²è¡Œç‚ºã€‚å¦‚æœæ‚¨ç¦ç”¨äº†æœå‹™ç«¯æ¸²æŸ“ï¼Œæ‚¨å°‡ç²å¾—ä¸€å€‹ SPAï¼ŒUniversal `load` å‡½æ•¸å§‹çµ‚åœ¨å®¢æˆ·ç«¯é‹è¡Œã€‚

å¦‚æœä¸€å€‹è·¯ç”±åŒæ™‚åŒ…å« Universal å’Œ server `load` å‡½æ•¸ï¼Œserver `load` å‡½æ•¸æœƒå…ˆé‹è¡Œã€‚

é™¤éæ‚¨é æ¸²æŸ“é é¢ - åœ¨é€™ç¨®æƒ…æ³ä¸‹ï¼Œå®ƒæœƒåœ¨æ§‹å»ºæ™‚è¢«èª¿ç”¨ï¼Œå¦å‰‡ `load` å‡½æ•¸æœƒåœ¨é‹è¡Œæ™‚è¢«èª¿ç”¨ã€‚

### Input
Universal å’Œ server `load` å‡½æ•¸éƒ½å¯ä»¥è¨ªå•æè¿°è«‹æ±‚çš„å±¬æ€§(`params`ã€`route` å’Œ `url`)ä»¥åŠå„ç¨®å‡½æ•¸(`fetch`ã€`setHeaders`ã€`parent`ã€`depends` å’Œ `untrack`)ã€‚é€™äº›åœ¨å¾Œé¢çš„ç« ç¯€ä¸­æœƒæè¿°ã€‚

server `load` å‡½æ•¸ä½¿ç”¨ `ServerLoadEvent` èª¿ç”¨ï¼Œå®ƒå¾ `RequestEvent` ç¹¼æ‰¿ `clientAddress`ã€`cookies`ã€`locals`ã€`platform` å’Œ `request`ã€‚

Universal `load` å‡½æ•¸ä½¿ç”¨å…·æœ‰ `data` å±¬æ€§çš„ `LoadEvent` èª¿ç”¨ã€‚å¦‚æœæ‚¨åœ¨ `+page.js` å’Œ `+page.server.js`(æˆ– `+layout.js` å’Œ `+layout.server.js`)ä¸­éƒ½æœ‰ `load` å‡½æ•¸ï¼Œå‰‡ server `load` å‡½æ•¸çš„è¿”å›å€¼æ˜¯ Universal `load` å‡½æ•¸åƒæ•¸çš„ `data` å±¬æ€§ã€‚

### Output
Universal `load` å‡½æ•¸å¯ä»¥è¿”å›åŒ…å«ä»»ä½•å€¼çš„å°è±¡ï¼ŒåŒ…æ‹¬è‡ªå®šç¾©é¡å’Œçµ„ä»¶æ§‹é€ å‡½æ•¸ç­‰å…§å®¹ã€‚

server `load` å‡½æ•¸å¿…é ˆè¿”å›å¯ä»¥ç”¨ devalue åºåˆ—åŒ–çš„æ•¸æ“š - ä»»ä½•å¯ä»¥ç”¨ JSON è¡¨ç¤ºçš„å…§å®¹ï¼Œä»¥åŠåƒ `BigInt`ã€`Date`ã€`Map`ã€`Set` å’Œ `RegExp` é€™æ¨£çš„å…§å®¹ï¼Œæˆ–é‡è¤‡/å¾ªç’°å¼•ç”¨ - é€™æ¨£å®ƒæ‰èƒ½é€šéç¶²çµ¡å‚³è¼¸ã€‚æ‚¨çš„æ•¸æ“šå¯ä»¥åŒ…å« `promises`ï¼Œåœ¨é€™ç¨®æƒ…æ³ä¸‹å®ƒå°‡è¢«æµå¼å‚³è¼¸åˆ°ç€è¦½å™¨ã€‚

### When to use which
ç•¶æ‚¨éœ€è¦ç›´æ¥è¨ªå•æ•¸æ“šåº«æˆ–æ–‡ä»¶ç³»çµ±ï¼Œæˆ–éœ€è¦ä½¿ç”¨ç§æœ‰ç’°å¢ƒè®Šé‡æ™‚ï¼Œserver `load` å‡½æ•¸å¾ˆæ–¹ä¾¿ã€‚

ç•¶æ‚¨éœ€è¦å¾å¤–éƒ¨ API fetch æ•¸æ“šä¸”ä¸éœ€è¦ç§æœ‰æ†‘æ“šæ™‚ï¼ŒUniversal load å‡½æ•¸å¾ˆæœ‰ç”¨ï¼Œå› ç‚º SvelteKit å¯ä»¥ç›´æ¥å¾ API ç²å–æ•¸æ“šè€Œç„¡éœ€é€šéæœå‹™ç«¯ã€‚ç•¶æ‚¨éœ€è¦è¿”å›ç„¡æ³•åºåˆ—åŒ–çš„å…§å®¹(å¦‚ Svelte çµ„ä»¶æ§‹é€ å‡½æ•¸)æ™‚ï¼Œå®ƒå€‘ä¹Ÿå¾ˆæœ‰ç”¨ã€‚

åœ¨æ¥µå°‘æ•¸æƒ…æ³ä¸‹ï¼Œæ‚¨å¯èƒ½éœ€è¦åŒæ™‚ä½¿ç”¨å…©è€… - ä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½éœ€è¦è¿”å›ä¸€å€‹ä½¿ç”¨æœå‹™ç«¯æ•¸æ“šåˆå§‹åŒ–çš„è‡ªå®šç¾©é¡çš„å¯¦ä¾‹ã€‚ç•¶åŒæ™‚ä½¿ç”¨å…©è€…æ™‚ï¼Œserver `load` çš„è¿”å›å€¼ä¸æœƒç›´æ¥å‚³éçµ¦é é¢ï¼Œè€Œæ˜¯å‚³éçµ¦ Universal `load` å‡½æ•¸(ä½œç‚º `data` å±¬æ€§):

`src/routes/+page.server.js`
```js
/** @type {import('./$types').PageServerLoad} */
export async function load() {
	return {
		serverMessage: 'hello from server load function'
	};
}
```

`src/routes/+page.js`
```js
/** @type {import('./$types').PageLoad} */
export async function load({ data }) {
	return {
		serverMessage: data.serverMessage,
		universalMessage: 'hello from universal load function'
	};
}
```

## Using URL data

é€šå¸¸ `load` å‡½æ•¸ä»¥æŸç¨®æ–¹å¼ä¾è³´æ–¼ `URL`ã€‚ç‚ºæ­¤ï¼Œ`load` å‡½æ•¸æä¾›äº† `url`ã€`route` å’Œ `params`ã€‚

### url

`URL` çš„ä¸€å€‹å¯¦ä¾‹ï¼ŒåŒ…å«è«¸å¦‚ `origin`ã€`hostname`ã€`pathname` å’Œ `searchParams`(åŒ…å«è§£æå¾Œçš„æŸ¥è©¢å­—ç¬¦ä¸²ï¼Œä½œç‚º `URLSearchParams` å°è±¡)ç­‰å±¬æ€§ã€‚åœ¨ `load` æœŸé–“ç„¡æ³•è¨ªå• `url.hash`ï¼Œå› ç‚ºå®ƒåœ¨æœå‹™ç«¯ä¸Šä¸å¯ç”¨ã€‚

### route

åŒ…å«ç•¶å‰è·¯ç”±ç›®éŒ„ç›¸å°æ–¼ `src/routes` çš„åç¨±:

`src/routes/a/[b]/[...c]/+page.js`
```js
/** @type {import('./$types').PageLoad} */
export function load({ route }) {
	console.log(route.id); 
  // log: '/a/[b]/[...c]'
}
```

### params

`params` æ˜¯å¾ `url.pathname` å’Œ `route.id` æ´¾ç”Ÿçš„ã€‚
çµ¦å®šä¸€å€‹ route.id ç‚º /a/[b]/[...c] ä¸” url.pathname ç‚º /a/x/y/z æ™‚ï¼Œparams å°è±¡å°‡å¦‚ä¸‹æ‰€ç¤º:

```json 
{
	"b": "x",
	"c": "y/z"
}
```


## Making fetch requests
è¦å¾å¤–éƒ¨ API æˆ– `+server.js` è™•ç†ç¨‹åºç²å–æ•¸æ“šï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æä¾›çš„ `fetch` å‡½æ•¸ï¼Œå®ƒçš„è¡Œç‚ºèˆ‡åŸç”Ÿ `fetch` web APIå®Œå…¨ç›¸åŒï¼Œä½†æœ‰ä¸€äº›é¡å¤–çš„åŠŸèƒ½:

- å®ƒå¯ä»¥åœ¨æœå‹™ç«¯ä¸Šç™¼èµ·å¸¶æ†‘æ“šçš„è«‹æ±‚ï¼Œå› ç‚ºå®ƒç¹¼æ‰¿äº†é é¢è«‹æ±‚çš„ `cookie` å’Œ `authorization` æ¨™é ­ã€‚
```
ğŸª ç”¨æˆ·çš„ cookies å’Œç™»å…¥ç‹€æ…‹æœƒè‡ªå‹•å‚³é

ç”¨æˆ·è«‹æ±‚é é¢æ™‚å¸¶è‘—ï¼š
â”œâ”€â”€ Cookie: session=abc123
â””â”€â”€ Authorization: Bearer token

SvelteKit fetch æœƒè‡ªå‹•å¸¶ä¸Šé€™äº›è³‡è¨Šï¼
```
- å®ƒå¯ä»¥åœ¨æœå‹™ç«¯ä¸Šç™¼èµ·ç›¸å°è«‹æ±‚(é€šå¸¸ï¼Œç•¶åœ¨æœå‹™ç«¯ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨æ™‚ï¼Œ`fetch` éœ€è¦å¸¶æœ‰æºçš„ `URL`)ã€‚
```js
// âœ… åœ¨ä¼ºæœå™¨ç«¯ä¹Ÿèƒ½ç”¨ç›¸å°è·¯å¾‘
const response = await fetch('/api/posts');  // è‡ªå‹•è®Šæˆå®Œæ•´ URL

// âŒ æ™®é€š fetch åœ¨ä¼ºæœå™¨ç«¯éœ€è¦å®Œæ•´ URL
const response = await fetch('https://mysite.com/api/posts');
```
- å…§éƒ¨è«‹æ±‚(ä¾‹å¦‚å° `+server.js` è·¯ç”±çš„è«‹æ±‚)åœ¨æœå‹™ç«¯ä¸Šé‹è¡Œæ™‚ç›´æ¥è½‰åˆ°è™•ç†å‡½æ•¸ï¼Œç„¡éœ€ HTTP èª¿ç”¨çš„é–‹éŠ·ã€‚
```
æ•ˆèƒ½å„ªåŒ–ï¼šç›´æ¥å‘¼å«è€Œä¸èµ°ç¶²è·¯

ç•¶ä½ å‘¼å«è‡ªå·±çš„ APIï¼š
fetch('/api/posts') 
      â†“
ä¸æœƒçœŸçš„ç™¼ HTTP è«‹æ±‚ï¼
      â†“
ç›´æ¥åŸ·è¡Œ +server.js è£¡çš„å‡½æ•¸
```
- åœ¨æœå‹™ç«¯æ¸²æŸ“æœŸé–“ï¼Œé€šééˆå…¥ `text`ã€`json` å’Œ `arrayBuffer` æ–¹æ³•ä¾†æ•ç²éŸ¿æ‡‰ä¸¦å°‡å…¶å…§è¯åˆ°æ¸²æŸ“çš„ HTML ä¸­ Response å°è±¡ã€‚è«‹æ³¨æ„ï¼Œé™¤éé€šé `filterSerializedResponseHeaders` é¡¯å¼åŒ…å«ï¼Œå¦å‰‡æ¨™é ­å°‡ä¸æœƒè¢«åºåˆ—åŒ–ã€‚
```
é˜²æ­¢é‡è¤‡è«‹æ±‚

ä¼ºæœå™¨ç«¯ï¼š
â”œâ”€â”€ fetch('/api/posts') â†’ å–å¾—è³‡æ–™
â”œâ”€â”€ æŠŠè³‡æ–™åµŒå…¥åˆ° HTML ä¸­
â””â”€â”€ å‚³é€çµ¦ç€è¦½å™¨

ç€è¦½å™¨ç«¯ï¼š
â”œâ”€â”€ ä¸éœ€è¦é‡æ–° fetch
â”œâ”€â”€ ç›´æ¥å¾ HTML è®€å–è³‡æ–™
â””â”€â”€ ç¯€çœç¶²è·¯è«‹æ±‚ï¼
```
- åœ¨ hydration ä¸­ï¼Œresponse å°‡å¾ HTML ä¸­è®€å–ï¼Œç¢ºä¿ä¸€è‡´æ€§ä¸¦é˜²æ­¢é¡å¤–çš„ç¶²çµ¡è«‹æ±‚ - å¦‚æœåœ¨ä½¿ç”¨ç€è¦½å™¨ `fetch` è€Œä¸æ˜¯ `load` çš„ `fetch` æ™‚ï¼Œåœ¨ç€è¦½å™¨æ§åˆ¶æ±ä¸­æ”¶åˆ°è­¦å‘Šï¼Œé€™å°±æ˜¯åŸå› ã€‚

`src/routes/items/[id]/+page.js`
```js
/** @type {import('./$types').PageLoad} */
export async function load({ fetch, params }) {
	const res = await fetch(`/api/items/${params.id}`);
	const item = await res.json();

	return { item };
}
```
```
ç”¨æˆ·è¨ªå• /blog
      â†“
ğŸ–¥ï¸ ä¼ºæœå™¨åŸ·è¡Œ load å‡½æ•¸
      â†“
ğŸ“¡ fetch('/api/posts') 
      â†“
ğŸ—„ï¸ å–å¾—éƒ¨è½æ ¼æ–‡ç« è³‡æ–™
      â†“
ğŸ¨ æ¸²æŸ“æˆå®Œæ•´ HTMLï¼š
   <article>æ–‡ç« 1</article>
   <article>æ–‡ç« 2</article>
   <script>
     // æŠŠè³‡æ–™åµŒå…¥é€™è£¡
     window.__sveltekit_data = { posts: [...] }
   </script>
      â†“
ğŸ“¤ å‚³é€çµ¦ç€è¦½å™¨
      â†“
ğŸŒ ç€è¦½å™¨æ”¶åˆ°å·²ç¶“æœ‰å…§å®¹çš„é é¢
      â†“
âš¡ Hydrationï¼šJavaScript å¾åµŒå…¥çš„è³‡æ–™æ¢å¾©ç‹€æ…‹
```

### Cookies
server `load` å‡½æ•¸å¯ä»¥ç²å–å’Œè¨­ç½® `cookies`ã€‚

`src/routes/+layout.server.js`
```js
// @filename: ambient.d.ts
declare module '$lib/server/database' {
  export function getUser(sessionid: string | undefined): Promise<{ name: string, avatar: string }>
}

// @filename: index.js
// ---cut---
import * as db from '$lib/server/database';

/** @type {import('./$types').LayoutServerLoad} */
export async function load({ cookies }) {
  const sessionid = cookies.get('sessionid');

  return {
    user: await db.getUser(sessionid)
  };
}
```

åªæœ‰ç•¶ç›®æ¨™ä¸»æ©Ÿèˆ‡ SvelteKit æ‡‰ç”¨ç¨‹åºç›¸åŒæˆ–æ˜¯å…¶æ›´å…·é«”çš„å­åŸŸåæ™‚ï¼ŒCookie æ‰æœƒé€šéæä¾›çš„ `fetch` å‡½æ•¸å‚³éã€‚

ä¾‹å¦‚ï¼Œå¦‚æœ SvelteKit æ­£åœ¨ç‚º my.domain.com æä¾›æœå‹™ï¼š
  - domain.com å°‡ä¸æœƒæ¥æ”¶ cookies
  - my.domain.com å°‡æœƒæ¥æ”¶ cookies
  - api.domain.com å°‡ä¸æœƒæ¥æ”¶ cookies
  - sub.my.domain.com å°‡æœƒæ¥æ”¶ cookies

ç•¶è¨­ç½® `credentials: 'include'` æ™‚ï¼Œå…¶ä»– cookies å°‡ä¸æœƒè¢«å‚³éï¼Œå› ç‚º SvelteKit ç„¡æ³•çŸ¥é“å“ªå€‹ cookie å±¬æ–¼å“ªå€‹åŸŸï¼ˆç€è¦½å™¨ä¸æœƒå‚³éé€™äº›ä¿¡æ¯ï¼‰ï¼Œæ‰€ä»¥è½‰ç™¼ä»»ä½• cookie éƒ½æ˜¯ä¸å®‰å…¨çš„ã€‚ä½¿ç”¨ handleFetch hook éˆå­ä¾†è§£æ±ºé€™å€‹å•é¡Œã€‚

## Headers

Universal å’Œ server `load` å‡½æ•¸éƒ½å¯ä»¥è¨ªå• `setHeaders` å‡½æ•¸ï¼Œç•¶åœ¨æœå‹™ç«¯ä¸Šé‹è¡Œæ™‚ï¼Œå¯ä»¥ç‚ºéŸ¿æ‡‰è¨­ç½®é ­éƒ¨ä¿¡æ¯ã€‚ï¼ˆåœ¨ç€è¦½å™¨ä¸­é‹è¡Œæ™‚ï¼Œ`setHeaders` ä¸æœƒç”¢ç”Ÿæ•ˆæœã€‚ï¼‰é€™åœ¨ä½ æƒ³è¦ç·©å­˜é é¢æ™‚å¾ˆæœ‰ç”¨ï¼Œä¾‹å¦‚ï¼š

`src/routes/products/+page.js`
```js
/** @type {import('./$types').PageLoad} */
export async function load({ fetch, setHeaders }) {
	const url = `https://cms.example.com/products.json`;
	const response = await fetch(url);

	// Headers are only set during SSR, caching the page's HTML
	// for the same length of time as the underlying data.
	setHeaders({
		age: response.headers.get('age'),
		'cache-control': response.headers.get('cache-control')
	});

	return response.json();
}
```

å¤šæ¬¡è¨­ç½®ç›¸åŒçš„æ¨™é ­ï¼ˆå³ä½¿åœ¨ä¸åŒçš„ `load` å‡½æ•¸ä¸­ï¼‰æ˜¯ä¸€å€‹éŒ¯èª¤ã€‚ä½¿ç”¨ `setHeaders` å‡½æ•¸æ™‚ï¼Œæ¯å€‹æ¨™é ­åªèƒ½è¨­ç½®ä¸€æ¬¡ã€‚ä½ ä¸èƒ½ä½¿ç”¨ `setHeaders` æ·»åŠ  `set-cookie` æ¨™é ­ â€” æ‡‰è©²ä½¿ç”¨ `cookies.set(name, value, options)` ä»£æ›¿ã€‚

```js
// âŒ éŒ¯èª¤
setHeaders({ 'set-cookie': 'session=abc123' });

// âœ… æ­£ç¢ºï¼šä½¿ç”¨ cookies API
export async function load({ cookies }) {
    cookies.set('session', 'abc123');
}
```

## Using parent data
æœ‰æ™‚å€™è®“ `load` å‡½æ•¸è¨ªå•çˆ¶ç´š `load` å‡½æ•¸ä¸­çš„æ•¸æ“šæ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œé€™å¯ä»¥é€šé `await parent()` å¯¦ç¾ï¼š

```
ğŸ“ src/routes/
â”œâ”€â”€ +layout.js           â†’ çˆºçˆº { a: 1 }
â”œâ”€â”€ abc/
â”‚   â”œâ”€â”€ +layout.js       â†’ çˆ¸çˆ¸ { b: 2 } (å¯ä»¥æ‹¿çˆºçˆºçš„ a)
â”‚   â””â”€â”€ +page.js         â†’ å…’å­ { c: 3 } (å¯ä»¥æ‹¿çˆºçˆ¸çš„ a, b)
```

`src/routes/+layout.js`
```js
/** @type {import('./$types').LayoutLoad} */
export function load() {
	return { a: 1 };
}
```

`src/routes/abc/+layout.js`
```js
/** @type {import('./$types').LayoutLoad} */
export async function load({ parent }) {
	const { a } = await parent();
	return { b: a + 1 };
}
```

`src/routes/abc/+page.js`
```js
/** @type {import('./$types').PageLoad} */
export async function load({ parent }) {
	const { a, b } = await parent();
	return { c: a + b };
}
```

`src/routes/abc/+page.svelte`
```svelte
<script>
  /** @type {{ data: import('./$types').PageData }} */
  let { data } = $props();
</script>

<!-- renders `1 + 2 = 3` -->
<p>{data.a} + {data.b} = {data.c}</p>
```

> â— æ³¨æ„ï¼Œ`+page.js` ä¸­çš„ `load` å‡½æ•¸æ¥æ”¶ä¾†è‡ªå…©å€‹ä½ˆå±€ `load` å‡½æ•¸çš„åˆä½µæ•¸æ“šï¼Œè€Œä¸åƒ…åƒ…æ˜¯ç›´æ¥çˆ¶ç´šçš„æ•¸æ“šã€‚

åœ¨ `+page.server.js` å’Œ `+layout.server.js` å…§éƒ¨ï¼Œ`parent` å¾çˆ¶ç´š `+layout.server.js` æ–‡ä»¶è¿”å›æ•¸æ“šã€‚

åœ¨ `+page.js` æˆ– `+layout.js` ä¸­ï¼Œå®ƒå°‡è¿”å›çˆ¶ç´š `+layout.js` æ–‡ä»¶ä¸­çš„æ•¸æ“šã€‚ç„¶è€Œï¼Œç¼ºå¤±çš„ `+layout.js` æœƒè¢«è¦–ç‚º `({ data }) => data` å‡½æ•¸ï¼Œé€™æ„å‘³ç€å®ƒä¹Ÿæœƒè¿”å›æœªè¢« `+layout.js` æ–‡ä»¶"é®è”½"çš„çˆ¶ç´š `+layout.server.js` æ–‡ä»¶ä¸­çš„æ•¸æ“šã€‚

ä½¿ç”¨ `await parent()` æ™‚è¦æ³¨æ„é¿å…ç€‘å¸ƒæµã€‚ä¾‹å¦‚ï¼Œ`getData(params)` ä¸¦ä¸ä¾è³´æ–¼èª¿ç”¨ `parent()` çš„çµæœï¼Œæ‰€ä»¥æˆ‘å€‘æ‡‰è©²å…ˆèª¿ç”¨å®ƒä»¥é¿å…å»¶é²æ¸²æŸ“ã€‚

`+page.js`
```js
// @filename: ambient.d.ts
declare function getData(params: Record<string, string>): Promise<{ meta: any }>

// @filename: index.js
// ---cut---
/** @type {import('./$types').PageLoad} */
export async function load({ params, parent }) {
  ---const parentData = await parent();---
  const data = await getData(params);
  const parentData = await parent();

  return {
    ...data,
    meta: { ...parentData.meta, ...data.meta }
  };
}
```

## Errors


## Cookies
æœåŠ¡ç«¯ load å‡½æ•°å¯ä»¥è·å–å’Œè®¾ç½®cookiesã€‚
```js
/// file: src/routes/+layout.server.js
// @filename: ambient.d.ts
declare module '$lib/server/database' {
  export function getUser(sessionid: string | undefined): Promise<{ name: string, avatar: string }>
}

// @filename: index.js
// ---cut---
import * as db from '$lib/server/database';

/** @type {import('./$types').LayoutServerLoad} */
export async function load({ cookies }) {
  const sessionid = cookies.get('sessionid');

  return {
    user: await db.getUser(sessionid)
  };
}
```
åªæœ‰å½“ç›®æ ‡ä¸»æœºä¸ SvelteKit åº”ç”¨ç¨‹åºç›¸åŒæˆ–æ˜¯å…¶æ›´å…·ä½“çš„å­åŸŸåæ—¶ï¼ŒCookie æ‰ä¼šé€šè¿‡æä¾›çš„ fetch å‡½æ•°ä¼ é€’ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœ SvelteKit æ­£åœ¨ä¸º my.domain.com æä¾›æœåŠ¡ï¼š

domain.com å°†ä¸ä¼šæ¥æ”¶ cookies
my.domain.com å°†ä¼šæ¥æ”¶ cookies
api.domain.com å°†ä¸ä¼šæ¥æ”¶ cookies
sub.my.domain.com å°†ä¼šæ¥æ”¶ cookies
å½“è®¾ç½® credentials: 'include' æ—¶ï¼Œå…¶ä»– cookies å°†ä¸ä¼šè¢«ä¼ é€’ï¼Œå› ä¸º SvelteKit æ— æ³•çŸ¥é“å“ªä¸ª cookie å±äºå“ªä¸ªåŸŸï¼ˆæµè§ˆå™¨ä¸ä¼šä¼ é€’è¿™äº›ä¿¡æ¯ï¼‰ï¼Œæ‰€ä»¥è½¬å‘ä»»ä½• cookie éƒ½æ˜¯ä¸å®‰å…¨çš„ã€‚ä½¿ç”¨ handleFetch hook é’©å­æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚